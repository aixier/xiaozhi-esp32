# 时序图集

## 1. 系统启动时序

```
┌─────────┐  ┌─────────┐  ┌───────────┐  ┌────────┐  ┌─────────┐
│ app_main│  │  Board  │  │ AudioSvc  │  │Protocol│  │ Display │
└────┬────┘  └────┬────┘  └─────┬─────┘  └───┬────┘  └────┬────┘
     │            │             │            │            │
     │ Initialize │             │            │            │
     │───────────▶│             │            │            │
     │            │ CreateCodec │            │            │
     │            │────────────▶│            │            │
     │            │             │            │            │
     │ Application::GetInstance()            │            │
     │─────────────────────────────────────────────────────▶
     │            │             │            │            │
     │ Start()    │             │            │            │
     │─────────────────────────────────────────────────────▶
     │            │             │            │            │
     │            │ Initialize  │            │            │
     │            │────────────▶│            │            │
     │            │             │            │            │
     │            │ CreateWakeWord           │            │
     │            │────────────▶│            │            │
     │            │             │            │            │
     │            │             │ CreateProtocol          │
     │            │             │────────────▶│            │
     │            │             │            │            │
     │            │             │            │ SetStatus  │
     │            │             │            │───────────▶│
     │            │             │            │ "Standby"  │
     │            │             │            │            │
     │ MainEventLoop()         │            │            │
     │─────────────────────────────────────────────────────▶
     │            │             │            │            │
     ▼            ▼             ▼            ▼            ▼
```

## 2. 对话流程时序

### 2.1 按钮触发对话

```
┌─────────┐  ┌───────────┐  ┌───────────┐  ┌────────┐  ┌────────┐
│  Button │  │Application│  │  Protocol │  │AudioSvc│  │ Server │
└────┬────┘  └─────┬─────┘  └─────┬─────┘  └───┬────┘  └───┬────┘
     │             │              │            │           │
     │ Press       │              │            │           │
     │────────────▶│              │            │           │
     │             │              │            │           │
     │             │ SetState(Connecting)      │           │
     │             │───────────────────────────▶           │
     │             │              │            │           │
     │             │ OpenAudioChannel         │           │
     │             │─────────────▶│            │           │
     │             │              │            │           │
     │             │              │ WS Connect │           │
     │             │              │───────────────────────▶│
     │             │              │            │           │
     │             │              │◀──── Hello ────────────│
     │             │              │            │           │
     │             │ OnChannelOpened          │           │
     │             │◀─────────────│            │           │
     │             │              │            │           │
     │             │ SetState(Listening)      │           │
     │             │───────────────────────────▶           │
     │             │              │            │           │
     │             │ SendStartListening       │           │
     │             │─────────────▶│            │           │
     │             │              │────listen:start───────▶│
     │             │              │            │           │
     │             │ EnableVoiceProcessing    │           │
     │             │──────────────────────────▶│           │
     │             │              │            │           │
     ▼             ▼              ▼            ▼           ▼
```

### 2.2 语音采集发送

```
┌─────────┐  ┌───────────┐  ┌───────────┐  ┌────────┐  ┌────────┐
│   MIC   │  │ AudioProc │  │OpusEncoder│  │ WebSocket│ │ Server │
└────┬────┘  └─────┬─────┘  └─────┬─────┘  └────┬────┘  └───┬────┘
     │             │              │             │            │
     │ PCM Data    │              │             │            │
     │────────────▶│              │             │            │
     │             │              │             │            │
     │             │ AFE Process  │             │            │
     │             │─────┐        │             │            │
     │             │     │        │             │            │
     │             │◀────┘        │             │            │
     │             │              │             │            │
     │             │ EncodeQueue  │             │            │
     │             │─────────────▶│             │            │
     │             │              │             │            │
     │             │              │ Opus Encode │            │
     │             │              │─────┐       │            │
     │             │              │     │       │            │
     │             │              │◀────┘       │            │
     │             │              │             │            │
     │             │              │ SendQueue   │            │
     │             │              │────────────▶│            │
     │             │              │             │            │
     │             │              │             │ BP3(0x00)  │
     │             │              │             │───────────▶│
     │             │              │             │            │
     │ (repeat for each frame)    │             │            │
     │             │              │             │            │
     ▼             ▼              ▼             ▼            ▼
```

### 2.3 TTS 接收播放

```
┌────────┐  ┌────────┐  ┌───────────┐  ┌───────────┐  ┌─────────┐
│ Server │  │WebSocket│  │DecodeQueue│  │OpusDecoder│  │ Speaker │
└───┬────┘  └────┬────┘  └─────┬─────┘  └─────┬─────┘  └────┬────┘
    │            │             │              │             │
    │ AUDIO_START (0x10)       │              │             │
    │───────────▶│             │              │             │
    │            │             │              │             │
    │            │ StartPrebuffering          │             │
    │            │────────────▶│              │             │
    │            │             │              │             │
    │ AUDIO_DATA (0x11)        │              │             │
    │───────────▶│             │              │             │
    │            │ Push        │              │             │
    │            │────────────▶│              │             │
    │            │             │              │             │
    │ (more frames...)         │ (buffering)  │             │
    │            │             │              │             │
    │            │             │ 5 frames     │             │
    │            │             │─────────────▶│             │
    │            │             │              │             │
    │            │             │              │ Decode      │
    │            │             │              │────┐        │
    │            │             │              │    │        │
    │            │             │              │◀───┘        │
    │            │             │              │             │
    │            │             │              │ PlaybackQueue
    │            │             │              │────────────▶│
    │            │             │              │             │
    │            │             │              │ PCM Output  │
    │            │             │              │────────────▶│
    │            │             │              │             │
    │ AUDIO_END (0x12)         │              │             │
    │───────────▶│             │              │             │
    │            │             │              │             │
    │            │ StopPrebuffering           │             │
    │            │────────────▶│              │             │
    │            │             │              │             │
    ▼            ▼             ▼              ▼             ▼
```

## 3. 唤醒词检测时序

```
┌─────────┐  ┌────────┐  ┌───────────┐  ┌───────────┐
│   MIC   │  │WakeWord│  │Application│  │  Protocol │
└────┬────┘  └───┬────┘  └─────┬─────┘  └─────┬─────┘
     │           │             │              │
     │ PCM Data  │             │              │
     │──────────▶│             │              │
     │           │             │              │
     │           │ Detect      │              │
     │           │────┐        │              │
     │           │    │        │              │
     │           │◀───┘        │              │
     │           │             │              │
     │           │ Wake Word Found!           │
     │           │────────────▶│              │
     │           │             │              │
     │           │             │ Schedule()   │
     │           │             │────┐         │
     │           │             │    │         │
     │           │             │◀───┘         │
     │           │             │              │
     │           │             │ OpenChannel  │
     │           │             │─────────────▶│
     │           │             │              │
     │           │             │ SendWakeWord │
     │           │             │─────────────▶│
     │           │             │              │
     ▼           ▼             ▼              ▼
```

## 4. WebSocket PING/PONG 时序

```
┌────────┐  ┌────────────┐  ┌──────────┐  ┌──────────┐
│ Server │  │ WebSocket  │  │ PongQueue│  │ PongTask │
└───┬────┘  └─────┬──────┘  └─────┬────┘  └────┬─────┘
    │             │               │            │
    │ PING Frame  │               │            │
    │────────────▶│               │            │
    │             │               │            │
    │             │ EnqueuePong   │            │
    │             │──────────────▶│            │
    │             │               │            │
    │             │               │ xQueueReceive
    │             │               │───────────▶│
    │             │               │            │
    │             │               │            │ SendControlFrame
    │             │◀──────────────────────────▶│
    │             │               │            │
    │◀─PONG Frame─│               │            │
    │             │               │            │
    ▼             ▼               ▼            ▼
```

## 5. 状态切换时序

```
┌───────────┐  ┌─────────┐  ┌───────────┐  ┌─────────┐
│Application│  │ Display │  │ AudioSvc  │  │EventBus │
└─────┬─────┘  └────┬────┘  └─────┬─────┘  └────┬────┘
      │             │             │             │
      │ SetDeviceState(Listening) │             │
      │────────────────────────────────────────▶│
      │             │             │             │
      │ SetStatus("Listening")    │             │
      │────────────▶│             │             │
      │             │             │             │
      │ EmitSetEmotion("neutral") │             │
      │────────────────────────────────────────▶│
      │             │             │             │
      │             │◀──Emit(DISPLAY_SET_EMOTION)
      │             │             │             │
      │             │ SetEmotion  │             │
      │             │────┐        │             │
      │             │    │        │             │
      │             │◀───┘        │             │
      │             │             │             │
      │ SendStartListening        │             │
      │───────────────────────────▶             │
      │             │             │             │
      │ EnableVoiceProcessing     │             │
      │──────────────────────────▶│             │
      │             │             │             │
      ▼             ▼             ▼             ▼
```

## 6. 错误处理时序

### 6.1 连接超时

```
┌───────────┐  ┌─────────┐  ┌───────────┐
│Application│  │ Protocol│  │  Display  │
└─────┬─────┘  └────┬────┘  └─────┬─────┘
      │             │             │
      │ OpenChannel │             │
      │────────────▶│             │
      │             │             │
      │             │ Connect...  │
      │             │────┐        │
      │             │    │ timeout│
      │             │◀───┘        │
      │             │             │
      │ OnNetworkError           │
      │◀────────────│             │
      │             │             │
      │ SetDeviceState(Idle)     │
      │────────────────────────────────▶
      │             │             │
      │ Alert("连接超时")        │
      │───────────────────────────▶
      │             │             │
      ▼             ▼             ▼
```

### 6.2 心跳超时

```
┌──────────────┐  ┌────────────────┐  ┌───────────┐
│ ConnManager  │  │ HeartbeatTimer │  │Application│
└──────┬───────┘  └───────┬────────┘  └─────┬─────┘
       │                  │                 │
       │ StartHeartbeat   │                 │
       │─────────────────▶│                 │
       │                  │                 │
       │                  │ (30s elapsed)   │
       │◀─────────────────│                 │
       │                  │                 │
       │ SendPing         │                 │
       │────────────────────────────────────▶
       │                  │                 │
       │                  │ (10s timeout)   │
       │◀─────────────────│                 │
       │                  │                 │
       │ Check pong_received_ = false       │
       │                  │                 │
       │ OnHeartbeatTimeout                 │
       │────────────────────────────────────▶
       │                  │                 │
       │ EmitConnectionFailed               │
       │────────────────────────────────────▶
       │                  │                 │
       ▼                  ▼                 ▼
```

## 7. 资源生命周期

```
┌─────────────────────────────────────────────────────────────────┐
│                        程序生命周期                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  app_main() ─────────────────────────────────────────────────▶ │
│       │                                                         │
│       ├── Application::GetInstance()  ◀─────────────────────────┤
│       │       │                                                 │
│       │       ├── protocol_ (unique_ptr)                        │
│       │       ├── audio_service_                                │
│       │       └── display_engine_                               │
│       │                                                         │
│       ├── Start()                                               │
│       │       │                                                 │
│       │       ├── AudioService::Initialize()                    │
│       │       │       ├── opus_encoder_ (unique_ptr)            │
│       │       │       ├── opus_decoder_ (unique_ptr)            │
│       │       │       ├── audio_processor_ (unique_ptr)         │
│       │       │       └── wake_word_ (unique_ptr)               │
│       │       │                                                 │
│       │       └── AudioService::Start()                         │
│       │               ├── audio_input_task_                     │
│       │               ├── audio_output_task_                    │
│       │               └── opus_codec_task_                      │
│       │                                                         │
│       └── MainEventLoop()  ─────────────────────────────────────┤
│               │                                    ∞ Loop       │
│               └─────────────────────────────────────────────────┤
│                                                                 │
│  ───────────────────── 按需创建/销毁 ─────────────────────────── │
│                                                                 │
│  OpenAudioChannel()                                             │
│       │                                                         │
│       └── websocket_ = network->CreateWebSocket()               │
│               │                                                 │
│               ├── pong_queue_ (FreeRTOS Queue)                  │
│               ├── pong_task_ (FreeRTOS Task)                    │
│               └── tcp_ (unique_ptr)                             │
│                                                                 │
│  CloseAudioChannel()                                            │
│       │                                                         │
│       └── websocket_.reset()                                    │
│               │                                                 │
│               └── ~WebSocket()                                  │
│                       ├── vQueueDelete(pong_queue_)             │
│                       ├── vTaskDelete(pong_task_)               │
│                       └── tcp_.reset()                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

*文档版本: 1.0*
